<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link type="text/css" rel="stylesheet" href="../libs/qunit.css"/>
    <script type="text/javascript" src="../libs/jquery-1.11.0.js"></script>
    <script type="text/javascript" src="../libs/qunit.js"></script>
    <script type="text/javascript">
        /**
         *
         */

        (function ($) {
            function Rotary(config) {
                var defaults = {
                    random: function () {
                        return Math.ceil(Math.random() * 2);
                    }
                };
                config = $.extend(defaults, config);
                var degrees = 360 / config.peices;
                var last = null;

                this.rotation = 0;
                function rotateTo(to) {
                    $(config.target).each(function () {
                        $.style(this, 'webkit-transform', 'rotate(' + to + 'deg)');
                        $.style(this, 'transform', 'rotate(' + to + 'deg)');
                    });
                }

                this.draw = function (which) {
                    var from = this.rotation;
                    var diff = which - last;
                    last = which;
                    var to = Math.floor((diff < 0 ? 1 : 0) + from / 360) * 360 + which * degrees + degrees / 2;
                    this.rotation = 360 * config.random() + to;
                    rotateTo(to);
                };
                this.reset = function () {
                    last = null;
                };
            }

            $.fn.rotary = function (config) {
                var key = 'rotary';
                if (!this.data(key)) {
                    this.data(key, new Rotary($.extend(config, {target: this})));
                }
                return this.data(key);
            }
        })(jQuery);

    </script>
    <script type="text/javascript">
        $(function () {
            var target = $("#rotary");
            var config = {peices: 6, random: function () {
                return 0;
            }};
            var rotary;
            module("Rotary", {
                setup: function () {
                    target.removeData('rotary');
                    rotary = target.rotary(config);
                }
            });
            test('draw', function () {
                equal(rotary.rotation, 0);
                rotary.draw(0);
                equal(rotary.rotation, 30);
                rotary.draw(1);
                equal(rotary.rotation, 90);
            });
            test('accumulate rotation', function () {
                rotary.draw(1);
                rotary.draw(0);
                equal(rotary.rotation, 1 * 360 + 30);
                rotary.draw(1);
                rotary.draw(0);
                equal(rotary.rotation, 2 * 360 + 30);
            });

            test('reset', function () {
                rotary.draw(1);
                rotary.reset();
                rotary.draw(0);
                equal(rotary.rotation, 30);
            });
            function get(id) {
                return document.getElementById(id);
            }

            test('rotate target after draw', function () {
                rotary.draw(0);
                var el = get('rotary');

                ok(el.getAttribute('style').indexOf('transform: rotate(30deg)') != -1);
                rotary.draw(2);
                ok(el.getAttribute('style').indexOf('transform: rotate(30deg)') == -1);
                ok(el.getAttribute('style').indexOf('transform: rotate(150deg)') != -1);
            });
            test('rotation accumulate random cycles', function () {
                var next = 0;
                target.removeData('rotary');
                rotary = target.rotary($.extend(config, {random: function () {
                    return [1, 2][next++];
                }}));
                rotary.draw(0);
                equal(rotary.rotation, 1 * 360 + 30);
                rotary.draw(1);
                equal(rotary.rotation, 2 * 360 + 390 + 60);
            });

            test('visibility of Rotary', function () {
                strictEqual(typeof Rotary, 'undefined');
            });

            test('cache rotary instance', function () {
                strictEqual(target.rotary(config), target.rotary(config));
            });

        });
    </script>
</head>
<body>
<div id="qunit"></div>
<div id="rotary"
     style="width:30px;height:30px;background: #f00;position: absolute;left:50%;top:30px;z-index: 1000;"></div>
</body>
</html>